events {
    worker_connections 1024;
}

http {
    upstream grpc_backend {
        server grpc-service:50051;
        # 다중 인스턴스 로드밸런싱
        # server grpc-service-2:50051;
        # server grpc-service-3:50051;
    }

    upstream tcp_backend {
        server tcp-service:4000;
        # 다중 인스턴스 로드밸런싱
        # server tcp-service-2:4000;
        # server tcp-service-3:4000;
    }

    # gRPC 프록시
    server {
        listen 80 http2;
        server_name grpc.police-thief.local;

        location / {
            grpc_pass grpc://grpc_backend;
            grpc_set_header Host $host;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }

    # API Gateway for HTTP/REST
    server {
        listen 80;
        server_name api.police-thief.local;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # TCP 서버 상태 확인 (HTTP 래퍼 필요시)
        location /tcp/status {
            proxy_pass http://tcp_backend/status;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 정적 파일 서빙 (게임 클라이언트 다운로드 등)
        location /static/ {
            root /var/www;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 모니터링 대시보드
    server {
        listen 80;
        server_name monitor.police-thief.local;

        location / {
            proxy_pass http://monitoring:9090;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }

    # 로그 설정
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}